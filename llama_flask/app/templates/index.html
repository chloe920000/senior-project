<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>漲LLa!嗎?</title>

    <!-- 網站圖標 -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='dist/assets/favicon.ico') }}" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" type="text/css" />

    <!-- Google 字體 -->
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css" />

    <!-- 主題樣式表，包含 Bootstrap 核心樣式 -->
    <link href="{{ url_for('static', filename='dist/css/styles.css') }}" rel="stylesheet" />
    <style>
        #loadingMessage {
            font-size: 16px;
            color: #555;
            text-align: center;
            margin-top: 20px;
        }
        #marquee {
            display: inline-block;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            color: white;
            font-size: 20px;
            background-color: #333;
            padding: 10px;
            text-align: center;
        }
        
        /* 跑馬燈動畫效果 */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
    
        /* 當加上 marquee-animation 時，啟動跑馬燈效果 */
        .marquee-animation {
            animation: marquee 10s linear infinite;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('prediction-form').onsubmit = async function (event) {
                event.preventDefault(); // Prevent default form submission behavior
        
                // Show loading message
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('result').innerHTML = '';  // Clear previous results
                document.getElementById('marquee').innerHTML = '正在分析中...';  // Initial marquee content
                document.getElementById('marquee').classList.add('marquee-animation'); // Start marquee animation
        
                const formData = new FormData(this); // Get form data
        
                try {
                    // Send both AJAX requests in parallel
                    const [predictResponse, newsResponse] = await Promise.all([
                        fetch('/predict', {
                            method: 'POST',
                            body: formData
                        }),
                        fetch('/news', {
                            method: 'POST',
                            body: formData
                        })
                    ]);
        
                    // Handle prediction response
                    if (predictResponse.ok) {
                        const [sentiment_mean, result] = await predictResponse.json();
                        document.getElementById('loadingMessage').style.display = 'none'; // Hide loading message
        
                        // Build and display prediction result table
                        let table = '<table class="table table-bordered"><thead><tr><th>Title</th><th>Details</th></tr></thead><tbody>';
                        table += `<tr><td colspan="2"><strong>Predictions</strong></td></tr>`;
                        for (let key in result) {
                            table += `<tr><td>${key}</td><td>${result[key]}</td></tr>`;
                        }
                        table += '</tbody></table>';
                        document.getElementById('dynamic-result').innerHTML = table;
        
                        // Handle sentiment_mean data
                        let sentimentTable = '<table class="table table-bordered"><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
                        sentimentTable += `<tr><td colspan="2"><strong>Sentiment Mean</strong></td></tr>`;
                        for (let stockID in sentiment_mean) {
                            let stockData = sentiment_mean[stockID];
                            for (let dateStr in stockData) {
                                let data = stockData[dateStr];
                                sentimentTable += `<tr><td>Stock ID</td><td>${stockID}</td></tr>`;
                                sentimentTable += `<tr><td>Date</td><td>${data['date']}</td></tr>`;
                                sentimentTable += `<tr><td>Arousal Mean</td><td>${data['arousal_mean']}</td></tr>`;
                                sentimentTable += `<tr><td>Count</td><td>${data['count']}</td></tr>`;
                            }
                        }
                        sentimentTable += '</tbody></table>';
                        document.getElementById('dynamic-sentiment-mean').innerHTML = sentimentTable;
                    } else {
                        document.getElementById('loadingMessage').innerHTML = 'Error: 無法取得預測結果';
                    }
        
                    // Handle news response
                    if (newsResponse.ok) {
                        const newsData = await newsResponse.json();
                        let newsHtml = '';
                        for (const [source, newsList] of Object.entries(newsData)) {
                            newsHtml += `<h2>${source}</h2><ul>`;
                            newsList.forEach(news => {
                                newsHtml += `<li><a href="${news.link}" target="_blank">${news.headline}</a></li>`;
                            });
                            newsHtml += `</ul>`;
                        }
                        document.getElementById('news-results').innerHTML = newsHtml; // Display news results in the new container
                    } else {
                        console.error('Error fetching news:', newsResponse.statusText);
                        document.getElementById('news-results').innerHTML = 'Error fetching news: ' + newsResponse.statusText;                    
                    }
        
                    // SSE for stock analysis
                    const eventSource = new EventSource('/sse_stock_analysis');
                    eventSource.onmessage = function (event) {
                        const marquee = document.getElementById('marquee');
                        marquee.innerHTML = event.data;
                        marquee.classList.add('marquee-animation');
                        if (event.data === "分析完成!") {
                            eventSource.close();
                            marquee.classList.remove('marquee-animation');
                            marquee.innerHTML = "分析完成!";
                        }
                    };
        
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('loadingMessage').innerHTML = 'Error: 無法連接到伺服器';
                }
            };
        });
    </script>
    

</head>

<body>
    <!-- 導航欄 -->
    <nav class="navbar navbar-light bg-light static-top">
        <div class="container">
            <!-- 網站名稱 -->
            <a class="navbar-brand" href="#!">Start Bootstrap</a>
            <!-- 註冊按鈕 -->
            <a class="btn btn-primary" href="#signup">Sign Up</a>
        </div>
    </nav>

    <!-- 頁面主體 -->
    <header class="masthead">
        <div class="container position-relative">
            <div class="row justify-content-center">
                <div class="col-xl-6">
                    <div class="text-center text-white">
                        <!-- 頁面標題 -->
                        <h1 class="mb-5">歡迎來到『漲LLa!嗎?』</h1>

                        <!-- 股票查詢表單 -->
                        <form class="form-subscribe" id="prediction-form" action="/predict" method="post">
                            <!-- 股票代碼輸入框 -->
                            <div class="row">
                                <div class="col">
                                    <input class="form-control form-control-lg" id="stock_data" name="stock_data" type="text" placeholder="請輸入股票代碼或名稱！" required />
                                    <div class="invalid-feedback text-white">Stock ID is required.</div>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary btn-lg" type="submit">Submit</button>
                                </div>
                            </div>

                            <!-- 成功與錯誤信息顯示區 -->
                            <div class="d-none" id="submitSuccessMessage">
                                <div class="text-center mb-3">
                                    <div class="fw-bolder">Form submission successful!</div>
                                </div>
                            </div>
                            <div class="d-none" id="submitErrorMessage">
                                <div class="text-center text-danger mb-3">Error sending message!</div>
                            </div>

                            <!-- 加載狀態 -->
                            <div id="loadingMessage" style="display:none; color: white;">正在訓練中，請稍後...</div>

                            <!-- 跑馬燈區域 -->
                            <div id="marquee" class="mt-3"></div>
                        </form>

                        <!-- 結果顯示區 -->
                        <div id="result"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 特徵展示區 -->
    <section class="features-icons bg-light text-center">
        <div class="container">
            <div class="row">
                <!-- LLama預測區 -->
                <div class="col-lg-4">
                    <div class="features-icons-item mx-auto mb-5 mb-lg-0 mb-lg-3">
                        <div class="features-icons-icon d-flex">
                            <i class="bi-window m-auto text-primary"></i>
                        </div>
                        <h3>LLama預測</h3>
                        <p class="lead mb-0">This theme will look great on any device, no matter the size!</p>
                        <div id="dynamic-result" class="mt-3" style="font-size: 20px;"></div>
                    </div>
                </div>

                <!-- 市場情緒區 -->
                <div class="col-lg-4">
                    <div class="features-icons-item mx-auto mb-5 mb-lg-0 mb-lg-3">
                        <div class="features-icons-icon d-flex">
                            <i class="bi-layers m-auto text-primary"></i>
                        </div>
                        <h3>市場情緒</h3>
                        <p class="lead mb-0">Featuring the latest build of the new Bootstrap 5 framework!</p>
                        <div id="dynamic-sentiment-mean" class="mt-3" style="font-size: 20px;"></div>
                    </div>
                </div>

                <!-- 重要新聞區 -->
                <div class="col-lg-4">
                    <div class="features-icons-item mx-auto mb-0 mb-lg-3">
<<<<<<< HEAD
                        <div class="features-icons-icon d-flex"><i class="bi-terminal m-auto text-primary"></i></div>
                        <h3>最新新聞</h3>
                        
=======
                        <div class="features-icons-icon d-flex">
                            <i class="bi-terminal m-auto text-primary"></i>
                        </div>
                        <h3>重要新聞</h3>
>>>>>>> 2bf07f63dd988058fc13e7c187e7ca855aa8c620
                        <p class="lead mb-0">Ready to use with your own content, or customize the source files!</p>
                        <div id="news-results" class="mt-3" style="font-size: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 頁腳 -->
    <footer class="footer bg-light">
        <div class="container">
            <div class="row">
                <!-- 左側資訊 -->
                <div class="col-lg-6 h-100 text-center text-lg-start my-auto">
                    <ul class="list-inline mb-2">
                        <li class="list-inline-item"><a href="#!">About</a></li>
                        <li class="list-inline-item">⋅</li>
                        <li class="list-inline-item"><a href="#!">Contact</a></li>
                        <li class="list-inline-item">⋅</li>
                        <li class="list-inline-item"><a href="#!">Terms of Use</a></li>
                        <li class="list-inline-item">⋅</li>
                        <li class="list-inline-item"><a href="#!">Privacy Policy</a></li>
                    </ul>
                    <p class="text-muted small mb-4 mb-lg-0">&copy; Your Website 2023. All Rights Reserved.</p>
                </div>

                <!-- 右側社交媒體 -->
                <div class="col-lg-6 h-100 text-center text-lg-end my-auto">
                    <ul class="list-inline mb-0">
                        <li class="list-inline-item me-4">
                            <a href="#!"><i class="bi-facebook fs-3"></i></a>
                        </li>
                        <li class="list-inline-item me-4">
                            <a href="#!"><i class="bi-twitter fs-3"></i></a>
                        </li>
                        <li class="list-inline-item">
                            <a href="#!"><i class="bi-instagram fs-3"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 核心 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 主題 JS 文件 -->
    <script src="{{ url_for('static', filename='dist/js/scripts.js') }}"></script>
    <!-- SB Forms JS 用於表單提交 -->
    <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>

</body>

<<<<<<< HEAD
</html>
=======
</html>
>>>>>>> 2bf07f63dd988058fc13e7c187e7ca855aa8c620
